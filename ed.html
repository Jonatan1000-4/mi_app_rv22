<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Gestor de Contenidos</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      padding: 30px;
      background: #f3f3f3;
      color: #333;
    }
    h2 {
      color: #444;
    }
    input, button {
      margin-top: 10px;
      padding: 8px;
    }
    #log {
      margin-top: 20px;
      background: #eee;
      padding: 10px;
      border-radius: 4px;
      white-space: pre-wrap;
    }
    progress {
      width: 100%;
      height: 20px;
      margin-top: 10px;
    }
  </style>
</head>
<body>

  <h2>üìÅ Procesador de Archivos</h2>

  <input type="file" id="fileInput" accept=".txt,.csv,.data"><br>
  <button onclick="procesarArchivo()">Procesar y Enviar</button>

  <progress id="barraProgreso" value="0" max="100"></progress>

  <div id="log">Esperando archivo...</div>

  <script>
    const GOOGLE_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbzqXdG41_YISkWAhmc8XFQp15XVnttYTypH8O90o9vcBAMRDITCKMz5dcnaUHAY-6Qu/exec';

    async function procesarArchivo() {
      const fileInput = document.getElementById('fileInput');
      const log = document.getElementById('log');
      const barra = document.getElementById('barraProgreso');

      if (!fileInput.files.length) {
        log.textContent = "‚ö†Ô∏è Selecciona un archivo primero.";
        return;
      }

      const reader = new FileReader();
      reader.onload = async function(e) {
        const lines = e.target.result.split('\n');
        const items = [];

        for (let i = 0; i < lines.length; i++) {
          if (lines[i].startsWith('#EXTINF')) {
            const dataLine = lines[i];
            const nextLine = lines[i + 1]?.trim();

            const logo = dataLine.match(/tvg-logo="([^"]+)"/)?.[1] || '';
            const group = dataLine.match(/group-title="([^"]+)"/)?.[1] || '';
            const name = dataLine.split(',').pop().trim();

            items.push({ name, url: nextLine, logo, group });
          }
        }

        log.textContent = `Total procesado: ${items.length} entradas\nIniciando env√≠o...`;
        barra.value = 0;

        for (let i = 0; i < items.length; i += 50) {
          const chunk = items.slice(i, i + 50);
          const formData = new FormData();
          formData.append("data", JSON.stringify(chunk));

          try {
            const res = await fetch(GOOGLE_SCRIPT_URL, {
              method: 'POST',
              body: formData
            });
            const text = await res.text();
            const porcentaje = Math.min(100, Math.floor(((i + 50) / items.length) * 100));
            barra.value = porcentaje;
            log.textContent = `Enviando... ${porcentaje}% completado (${i + 50}/${items.length})\n√öltima respuesta: ${text}`;
          } catch (err) {
            log.textContent += `\n‚ùå Error: ${err}`;
            break;
          }
        }

        log.textContent += `\n‚úÖ Proceso finalizado.`;
      };

      reader.readAsText(fileInput.files[0]);
    }
  </script>
</body>
</html>
