<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Procesador Optimizado</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      background: #f9f9f9;
      padding: 30px;
      color: #222;
    }
    h2 { margin-bottom: 10px; }
    input[type="file"], button {
      padding: 10px;
      margin: 10px 0;
    }
    #categorias {
      background: #fff;
      padding: 15px;
      border: 1px solid #ccc;
      max-height: 300px;
      overflow-y: auto;
      margin-top: 10px;
    }
    .categoria {
      margin-bottom: 5px;
      font-size: 14px;
    }
    progress {
      width: 100%;
      height: 20px;
      margin-top: 10px;
    }
    #log {
      margin-top: 20px;
      background: #eee;
      padding: 10px;
      border-radius: 5px;
      white-space: pre-wrap;
      font-size: 14px;
    }
  </style>
</head>
<body>

  <h2>üìÅ Procesador de Contenido</h2>

  <input type="file" id="fileInput" accept=".txt,.csv,.data">
  <button onclick="analizarArchivo()">Analizar</button>

  <div id="categorias">üìå Esperando archivo...</div>

  <button onclick="enviarSeleccion()">Enviar Seleccionados</button>
  <progress id="barraProgreso" value="0" max="100"></progress>

  <div id="log">Log de proceso...</div>

  <script>
    const GOOGLE_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbzqXdG41_YISkWAhmc8XFQp15XVnttYTypH8O90o9vcBAMRDITCKMz5dcnaUHAY-6Qu/exec';

    let canales = [];

    function analizarArchivo() {
      const archivo = document.getElementById('fileInput').files[0];
      const log = document.getElementById('log');
      const categoriasDiv = document.getElementById('categorias');

      if (!archivo) {
        log.textContent = '‚ö†Ô∏è Selecciona un archivo v√°lido.';
        return;
      }

      const reader = new FileReader();
      reader.onload = function(e) {
        const lineas = e.target.result.split('\n');
        canales = [];
        const contadorCategorias = {};

        for (let i = 0; i < lineas.length; i++) {
          if (lineas[i].startsWith('#EXTINF')) {
            const datos = lineas[i];
            const url = lineas[i + 1]?.trim();
            const nombre = datos.split(',').pop().trim();
            const logo = datos.match(/tvg-logo="([^"]+)"/)?.[1] || '';
            const grupo = datos.match(/group-title="([^"]+)"/)?.[1] || 'Sin grupo';

            canales.push({ name: nombre, url, logo, group: grupo });
            contadorCategorias[grupo] = (contadorCategorias[grupo] || 0) + 1;
          }
        }

        // Mostrar categor√≠as
        const categorias = Object.keys(contadorCategorias).sort((a, b) => a.localeCompare(b));
        categoriasDiv.innerHTML = '<strong>Selecciona categor√≠as:</strong><br>';

        categorias.forEach(cat => {
          const id = 'cat_' + btoa(cat).replace(/[^a-z0-9]/gi, '');
          categoriasDiv.innerHTML += `
            <div class="categoria">
              <input type="checkbox" id="${id}" name="categoria" value="${cat}" checked>
              <label for="${id}">${cat} (${contadorCategorias[cat]})</label>
            </div>
          `;
        });

        log.textContent = `üîç Procesado: ${canales.length} entradas, ${categorias.length} grupos.`;
      };

      reader.readAsText(archivo);
    }

    async function enviarSeleccion() {
      const seleccionados = [...document.querySelectorAll('input[name="categoria"]:checked')].map(e => e.value);
      const barra = document.getElementById('barraProgreso');
      const log = document.getElementById('log');

      if (seleccionados.length === 0) {
        log.textContent = '‚ö†Ô∏è Debes seleccionar al menos una categor√≠a.';
        return;
      }

      const filtrados = canales.filter(c => seleccionados.includes(c.group));
      if (filtrados.length === 0) {
        log.textContent = '‚ö†Ô∏è No hay entradas que coincidan.';
        return;
      }

      log.textContent = `‚è≥ Enviando ${filtrados.length} entradas...`;
      barra.value = 0;

      for (let i = 0; i < filtrados.length; i += 50) {
        const bloque = filtrados.slice(i, i + 50);
        const formData = new FormData();
        formData.append('data', JSON.stringify(bloque));

        try {
          const res = await fetch(GOOGLE_SCRIPT_URL, {
            method: 'POST',
            body: formData
          });
          const txt = await res.text();
          const progreso = Math.floor(((i + 50) / filtrados.length) * 100);
          barra.value = progreso;
          log.textContent = `‚úÖ ${progreso}% completado (${i + 50}/${filtrados.length})\n√öltima respuesta: ${txt}`;
        } catch (err) {
          log.textContent += `\n‚ùå Error: ${err}`;
          break;
        }
      }

      log.textContent += '\n‚úîÔ∏è Proceso finalizado.';
    }
  </script>

</body>
</html>
