<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>‚Üî Google Sheets</title>
  <style>
    body { font-family: Arial; padding: 20px; background: #f3f3f3; }
    h2 { color: #444; }
    input, button { margin: 10px 0; }
    #log { background: #eee; padding: 10px; border-radius: 5px; white-space: pre-wrap; }
  </style>
</head>
<body>
  <h2>üîÅ‚Üî Google Sheets</h2>

  <input type="file" id="m3uFile" accept=".m3u"><br>
  <button onclick="processM3U()">Enviar a Google Sheets</button><br><br>
  <button onclick="downloadM3U()">‚¨áÔ∏è Descargar</button>

  <div id="log">üß† Esperando acci√≥n...</div>

  <script>
    const GOOGLE_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbzqXdG41_YISkWAhmc8XFQp15XVnttYTypH8O90o9vcBAMRDITCKMz5dcnaUHAY-6Qu/exec'; // <== Pega la URL del Web App aqu√≠

    async function processM3U() {
      const fileInput = document.getElementById('m3uFile');
      const log = document.getElementById('log');

      if (!fileInput.files.length) {
        log.textContent = "‚ö†Ô∏è Selecciona un archivo .m3u primero.";
        return;
      }

      const reader = new FileReader();
      reader.onload = async function(e) {
        const lines = e.target.result.split('\n');
        const channels = [];

        for (let i = 0; i < lines.length; i++) {
          if (lines[i].startsWith('#EXTINF')) {
            const extinf = lines[i];
            const url = lines[i + 1]?.trim();

            const logo = extinf.match(/tvg-logo="([^"]+)"/)?.[1] || '';
            const group = extinf.match(/group-title="([^"]+)"/)?.[1] || '';
            const name = extinf.split(',').pop().trim();

            channels.push({ name, url, logo, group });
          }
        }

        log.textContent = `‚è≥ Procesando ${channels.length} canales...`;

        for (let i = 0; i < channels.length; i += 50) {
          const chunk = channels.slice(i, i + 50);
          const formData = new FormData();
          formData.append("data", JSON.stringify(chunk));

          const res = await fetch(GOOGLE_SCRIPT_URL, {
            method: 'POST',
            body: formData
          });

          const text = await res.text();
          log.textContent += `\n‚úîÔ∏è Chunk enviado: ${text}`;
        }

        log.textContent += `\n‚úÖ Finalizado. Todos los canales fueron enviados.`;
      };

      reader.readAsText(fileInput.files[0]);
    }

    async function downloadM3U() {
      const log = document.getElementById('log');
      log.textContent = "üì• Descargando desde Sheets...";

      try {
        const res = await fetch(GOOGLE_SCRIPT_URL);
        const channels = await res.json();

        let m3uContent = '#EXTM3U\n';
        channels.forEach(ch => {
          m3uContent += `#EXTINF:-1 tvg-logo="${ch.logo}" group-title="${ch.group}",${ch.name}\n${ch.url}\n`;
        });

        const blob = new Blob([m3uContent], { type: 'text/plain' });
        const a = document.createElement('a');
        a.href = URL.createObjectURL(blob);
        a.download = 'canales_from_sheets.m3u';
        document.body.appendChild(a);
        a.click();
        a.remove();

        log.textContent += `\n‚úÖ Descargado: ${channels.length} canales`;
      } catch (err) {
        log.textContent += `\n‚ùå Error al descargar: ${err}`;
      }
    }
  </script>
</body>
</html>
