<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Gestor con Filtro de Categor√≠as</title>
  <style>
    body { font-family: Arial, sans-serif; padding: 30px; background: #f0f0f0; color: #333; }
    input, button { margin: 10px 0; padding: 8px; }
    #categorias { margin: 20px 0; padding: 10px; background: #fff; border: 1px solid #ccc; max-height: 300px; overflow-y: auto; }
    .categoria { margin-bottom: 5px; }
    #log { white-space: pre-wrap; background: #eee; padding: 10px; border-radius: 4px; margin-top: 20px; }
    progress { width: 100%; height: 20px; margin-top: 10px; }
  </style>
</head>
<body>

  <h2>üìÅ Procesar Archivo con Filtro</h2>

  <input type="file" id="fileInput" accept=".txt,.csv,.data"><br>
  <button onclick="analizarArchivo()">Analizar Categor√≠as</button>

  <div id="categorias">‚ö†Ô∏è A√∫n no se ha cargado ning√∫n archivo.</div>

  <button onclick="enviarSeleccionados()">Enviar Selecci√≥n</button>
  <progress id="barraProgreso" value="0" max="100"></progress>

  <div id="log">Esperando archivo...</div>

  <script>
    const GOOGLE_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbzqXdG41_YISkWAhmc8XFQp15XVnttYTypH8O90o9vcBAMRDITCKMz5dcnaUHAY-6Qu/exec';

    let todosLosCanales = [];

    function analizarArchivo() {
      const input = document.getElementById('fileInput');
      const log = document.getElementById('log');
      const categoriasDiv = document.getElementById('categorias');

      if (!input.files.length) {
        log.textContent = "‚ö†Ô∏è Selecciona un archivo.";
        return;
      }

      const reader = new FileReader();
      reader.onload = function(e) {
        const lines = e.target.result.split('\n');
        todosLosCanales = [];

        for (let i = 0; i < lines.length; i++) {
          if (lines[i].startsWith('#EXTINF')) {
            const dataLine = lines[i];
            const nextLine = lines[i + 1]?.trim();

            const logo = dataLine.match(/tvg-logo="([^"]+)"/)?.[1] || '';
            const group = dataLine.match(/group-title="([^"]+)"/)?.[1] || 'Sin categor√≠a';
            const name = dataLine.split(',').pop().trim();

            todosLosCanales.push({ name, url: nextLine, logo, group });
          }
        }

        // Extraer categor√≠as √∫nicas
        const categorias = [...new Set(todosLosCanales.map(c => c.group))].sort();

        // Mostrar checkboxes
        categoriasDiv.innerHTML = '<strong>Selecciona las categor√≠as a enviar:</strong><br>';
        categorias.forEach(cat => {
          const id = 'cat_' + btoa(cat).replace(/[^a-z0-9]/gi, '');
          categoriasDiv.innerHTML += `
            <div class="categoria">
              <input type="checkbox" id="${id}" name="categoria" value="${cat}" checked>
              <label for="${id}">${cat}</label>
            </div>
          `;
        });

        log.textContent = `üéØ Archivo procesado. Total de categor√≠as: ${categorias.length}. Total de entradas: ${todosLosCanales.length}.`;
      };

      reader.readAsText(input.files[0]);
    }

    async function enviarSeleccionados() {
      const log = document.getElementById('log');
      const barra = document.getElementById('barraProgreso');
      const seleccionados = [...document.querySelectorAll('input[name="categoria"]:checked')].map(e => e.value);

      if (seleccionados.length === 0) {
        log.textContent = "‚ö†Ô∏è No seleccionaste ninguna categor√≠a.";
        return;
      }

      const filtrados = todosLosCanales.filter(c => seleccionados.includes(c.group));
      log.textContent = `üì§ Enviando ${filtrados.length} entradas...`;
      barra.value = 0;

      for (let i = 0; i < filtrados.length; i += 50) {
        const chunk = filtrados.slice(i, i + 50);
        const formData = new FormData();
        formData.append("data", JSON.stringify(chunk));

        try {
          const res = await fetch(GOOGLE_SCRIPT_URL, {
            method: 'POST',
            body: formData
          });
          const respuesta = await res.text();
          const porcentaje = Math.floor(((i + 50) / filtrados.length) * 100);
          barra.value = porcentaje;
          log.textContent = `‚úÖ Enviando... ${porcentaje}% (${i + 50}/${filtrados.length})\n√öltima respuesta: ${respuesta}`;
        } catch (err) {
          log.textContent += `\n‚ùå Error: ${err}`;
          break;
        }
      }

      log.textContent += `\n‚úîÔ∏è Proceso finalizado.`;
    }
  </script>
</body>
</html>
